---
title: "Abundance - Vocal activity rate and count data"
author: "Meghan A. Beatty"
date: "2026-01-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Code purpose

We have three goals:

1.  Calculate species vocal activity rate (e.g., \# detections per sampling occasion) from BirdNET output.

2.  Estimate abundance using count data and N-mixture models.

3.  Relate vocal activity rate (VAR) to estimated species abundance to calculate an acoustically-derived index of abundance. We will also compare how this relationship compares to using raw count data.

## 1) Calculate species vocal activity rate from BirdNET output

In a real-world use case, we would use the BirdNET output to calculate different measures of VAR to test. Example measures of VAR could include:

-   \# detections per sampling occasion

-   time to first to detection per sampling occasion

-   time between first and last detection per sampling occasion

For simplicity, here will simulate detections per sampling occasion for an imaginary species. A sampling occasion could vary greatly depending on your species and study design. For example, if the ARUs are paired with an avian point count study, you may calculate the number of songs initiated within a 10-minute interval. If your ARU's are paired with counts of elephants, it may be the number of bugles detected over the course of an hour. We assume if no individuals were present, no detections would be recorded (i.e., no false positives).

```{r simulate VAR}

#set seed to ensure we get the same values
set.seed(123)

#define expected number of detections per site
means <- rep(c(0,5,10,15,20),10)
means

#create a site by visit dataframe to fill in with a detection history
VAR <- matrix(NA, nrow = 50, ncol = 10)

#simulate detections per sampling occasion based on the expected value assigned above
for (i in 1:nrow(VAR)) {
    tmp <- rpois(ncol(VAR), lambda = means[i])
    VAR[i, ] <- tmp[1:ncol(VAR)]
  }
VAR <- as.data.frame(VAR)

#get average detections per site
VAR.mean <- rowMeans(VAR); VAR.mean

```

We now have simulated the average number of species detections per sampling occasion across 50 sites .

## 2) Estimate abundance using count data and N-mixture models

In a real-world use case, we would use counts collected at human audio/visual count surveys that were paired with ARUs. Here we will simulate count data that meets our expectation that VAR increases with increasing bird abundance.

```{r simulate counts}

#define number of sites and number of sampling occasions to match the VAR data
nSites <- 50
nOcc   <- 10

# define true abundance 
  # in this we case we assume the number of animals vary between 0 and 4 per site;
  # thus, our simulated VAR data expects that an animal is detected by the ARU 5x per sampling occasion
N <- rep(c(0:4),10) 

# define true detection
p <- 0.3                

#create dataframe for observed counts
y <- matrix(NA, nSites, nOcc) 

#simulate observed counts with imperfect detection
for(i in 1:nSites){
  y[i, ] <- rbinom(nOcc, N[i], p) 
}


```

Next we will take our simulated observed counts and estimate abundance at each site using an N-mixture model in the 'unmarked' package, incorporating imperfect detection of individuals at each site.

```{r estimate abundance}

library(unmarked)

#define site names
sites <- paste0("site", 1:50)

#run the unmarked model
umf <- unmarkedFramePCount(y = y, siteCovs = data.frame(sites=as.factor(sites)))

model1 <- pcount(~1 ~1, umf, K = 100)
model1

#this should be close to our defined p
plogis(coef(model1, type="det")) 

# empirical Bayes estimation of random effects
model1re <- ranef(model1); model1re
#extract the mean estimated abundance per site
pred <- data.frame(abund.est = bup(model1re, state = "mean")) 
# estimated summed abundance across sites
sum(bup(model1re))    
# actual summed abundance across sites
sum(N)                     

#round estimated abundance to integer for use below
pred$abund.est <- round(pred$abund.est, 0)


```

## 2) Relate vocal activity rate (VAR) to estimated species abundance and raw count data

We will fit generalized linear models with a Poisson distribution because we are using count data. We use estimated abundance and maximum observed counts as the response variables and VAR as the predictor. 

```{r glm}

#add the maximum raw count per site to the prediction dataframe
pred$max.count <- apply(y, 1, max)

#add mean VAR per site to the prediction dataframe
pred$VAR <- VAR.mean

#look at correlations between counts and VAR
cor(pred[, c("VAR", "abund.est", "max.count")])

#relate estimated abundance to VAR 
m.abund <- glm(abund.est ~ VAR, family = poisson, data = pred)
summary(m.abund)

#relate maximum observed count to VAR 
m.count <- glm(max.count ~ VAR, family = poisson, data = pred)
summary(m.count)

```

Let's compare the results on a plot.

```{r plot}

#create data for predictions
newdata <- as.data.frame(pred)

#predict abundance
abund.pred <- predict(m.abund, newdata = newdata, type = "response", se.fit = TRUE)
# 95% CI
abund.pred <- data.frame(
  fit   = abund.pred$fit,
  se    = abund.pred$se.fit,
  lower = abund.pred$fit - 1.96 * abund.pred$se.fit,
  upper = abund.pred$fit + 1.96 * abund.pred$se.fit
  )
abund.pred$type <- "abund"
abund.pred$abund <- N
abund.pred$VAR <- newdata$VAR

#predict observed counts
count.pred <- predict(m.count, newdata = newdata, type = "response", se.fit = TRUE)
# 95% CI
count.pred <- data.frame(
  fit   = count.pred$fit,
  se    = count.pred$se.fit,
  lower = count.pred$fit - 1.96 * count.pred$se.fit,
  upper = count.pred$fit + 1.96 * count.pred$se.fit
  )
count.pred$type <- "count"
count.pred$abund <- N
count.pred$VAR <- newdata$VAR


#combine dataframes
plot <- rbind(abund.pred, count.pred)

#plot results
library(ggplot2)
ggplot(plot) +
  geom_line(aes(x = VAR, y = fit, color = type))  + 
  geom_point(aes(x = VAR, y = abund, fill = type)) +
  #geom_ribbon(aes(x = VAR, ymin = lower, ymax = upper), alpha = 0.1) + #to look at confidence intervals
  #facet_wrap(~type) + #to make each plot in it's own pane
  ylab("abundance") + xlab("vocal activity rate") +
  theme_classic()


```

Was VAR a better predictor of estimated abundance or the maximum observed counts? How does this change as we change our detection probability defined above (p)?

