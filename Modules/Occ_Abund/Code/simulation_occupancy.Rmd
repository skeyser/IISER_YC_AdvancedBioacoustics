---
title: "IISER Advanced Bioacoustics Workshop - Occupancy Simulation"
output: html_document
date: "February 2026"
editor_options: 
  chunk_output_type: inline
---

# Recommended reading

-   Designing occupancy studies: General advice and allocating survey effort (Mackenzie and Royle 2005)

-   What does 'occupancy' mean in passive acoustic surveys? (Wood and Peery 2022)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
#Load packages
library(unmarked) #for occupancy modeling
library(ggplot2) #for plotting

```

## Manually simulate occupancy data

First we will manually simulate true occupancy and detection matrices by providing the following parameters:

$\psi$ - mean occupancy probability across sites

$p$ - detection probability (assumed constant across all sites and visits, but this could be relaxed)

```{r manual simulation}
set.seed(5) #to ensure we all get the same values from simulation

# Manually simulate occupancy data
M <- 100 # number of sites
psi <- 0.5 # true occupancy probability 
occupancy_status <- rbinom(M, 1, psi) # simulate occupancy for 100 sites (1 trial per site)

J <- 3 # number of surveys per site
p <- 0.5 # true detection probability

# create matrix for detection history
detection_history <- matrix(NA, nrow = M, ncol = J)

# simulate detection (observation) matrix based on detection probability and number of surveys per site
for (i in 1:M) {
  if (occupancy_status[i] == 1) {
    detection_history[i, ] <- rbinom(J, 1, p)
  } else {
    detection_history[i, ] <- 0 #If the site is not occupied no detections occur
  }
}

  # create unmarkedFrame
  umf1 <- unmarkedFrameOccu(y = detection_history)
  # run ?occu() to read more about the function
  mod1 <- occu(~1~1, umf1)
  # check that occupancy and detection matches our inputs
  plogis(coef(mod1))

```

## Simulate occupancy with a single covariate (e.g., elevation)

Next we will build on the above simulation and allow occupancy to vary by differences in elevation by site.

```{r manual simulation with cov}
set.seed(5)

# Manually simulate occupancy data

M <- 100 # Number of sites
J <- 3 # Number of surveys per site
p <- 0.5 # True detection probability


# Add a site-level covariate for occupancy
# simulate values for elevation
elev <- rnorm(M, 0) 

# assign psi intercept on probability scale and change it logit scale
psi <- qlogis(0.5) 

# assign intercept and slope for occupancy 
  #(this indicates a negative relationship between occupancy and elevation)
beta_psi <- c(psi, -1) 

# calculate occupancy with elevation at each site
logit_psi <- beta_psi[1] + beta_psi[2] * elev 

# transform site occupancy to probability 
psi_variable <- plogis(logit_psi) 

# simulate true site occupancy status
occupancy_status_cov <- rbinom(M, 1, psi_variable) 

# create matrix for detection history
detection_history <- matrix(NA, nrow = M, ncol = J)

# simulate detection matrix based on detection probability and number of surveys per site
for (i in 1:M) {
  if (occupancy_status_cov[i] == 1) {
    detection_history[i, ] <- rbinom(J, 1, p)
  } else {
    detection_history[i, ] <- 0 #if the site is not occupied no detections occur
  }
}

  # create unmarkedFrame
  umf2 <- unmarkedFrameOccu(y = detection_history, data.frame(elev = elev))
  mod2 <- occu(~1~elev, umf2)
  # check that occupancy and detection matches our inputs
  plogis(coef(mod2))

```

## Simulate occupancy using simulate() in the package 'unmarked'

Alternatively, you can simulate occupancy in the package 'unmarked'.

```{r manual simulation with unmarked}
set.seed(5)

  #See ??unmarked::simulate for more information

  # first create an unmarkedFrame with the correct design
  
  M <- 100 # number of sites
  J <- 3   # number of occasions
  
  # create a detection matrix (often specified as 'y'); also called the 'observation' matrix
  y <- matrix(NA, M, J)
  
  # simulate site elevation covariate
  elev <- rnorm(M, 0)
  
  # create unmarkedFrame
  umf <- unmarkedFrameOccu(y = y, siteCovs = data.frame(elev = elev))
  
  # write a formula to specify the model structure we want to simulate
    #this indicates no covariates on detection, and occupancy varies by elevation
  form <- ~1 ~elev
  
  # assign an occupancy intercept and detection of 0.5 and a negative effect of increasing elevation
    # (0.5 corresponds to zero on the inverse link scale) 
  cf <- list(state = c(0,-1), det = 0)
  plogis(0); plogis(-1)
  # Run simulation; Must specify model = occu 
  s <- simulate(umf, model = occu, formula = form, coefs = cf)
  
  #examine detection history
  head(s[[1]])
  
  #run model
  mod3 <- occu(~1~elev, s[[1]])
  mod3
  
  #check that occupancy and detection matches how we would expect
  plogis(coef(mod3))
  
```

## Plot results

We will now plot our raw data and predictions for occupancy as function of elevation.

```{r plotting}
set.seed(5)

#create data for predictions
newdata <- as.data.frame(elev)
#predict onto new data
pred <- predict(mod2, newdata = newdata, type = "state", appendData = TRUE)
head(pred)

#plot results
ggplot(data = pred) +
  geom_line(aes(x = elev, y = Predicted))  + 
  geom_ribbon(aes(x = elev, ymin = lower, ymax = upper), alpha = 0.1) +
  theme_minimal()
  
```

## Explore varying parameter values and the outcome on occupancy and uncertainty

Manipulate, M, J, $\psi$, $p$, and the elevation coefficient to examine how that influences your output. See "#CHANGE ME" for places to modify.

```{r exploration}
set.seed(5)

#Manually simulate occupancy data
M <- 100 # Number of sites #CHANGE ME
J <- 3 # Number of surveys per site #CHANGE ME
p <- 0.9 # True detection probability #CHANGE ME
psi <- qlogis(0.5) #Assign psi on probability scale and then change it to logit scale #CHANGE ME


#Add a site-level covariate for occupancy
beta_psi <- c(psi, -1) # Assign intercept and slope for occupancy
elev <- rnorm(M, 0) #simulate values for elevation
logit_psi <- beta_psi[1] + beta_psi[2] * elev # Calculate occupancy by site
psi_variable <- plogis(logit_psi) # Transform occupancy to probability 
occupancy_status_cov <- rbinom(M, 1, psi_variable) # Simulate true site occupancy status

#Create matrix for detection history
detection_history <- matrix(NA, nrow = M, ncol = J)

#Simulate detection matrix based on detection probability and number of surveys per site
for (i in 1:M) {
  if (occupancy_status_cov[i] == 1) {
    detection_history[i, ] <- rbinom(J, 1, p)
  } else {
    detection_history[i, ] <- 0 #If the site is not occupied no detections occur
  }
}

  # Create unmarkedFrame
  umf.exp <- unmarkedFrameOccu(y = detection_history, data.frame(elev = elev))
  mod.exp <- occu(~1 ~elev, umf.exp)
  # Check that occupancy and detection matches our inputs
  plogis(coef(mod.exp))
  newdata <- as.data.frame(elev)

pred.exp <- predict(mod.exp, newdata = newdata, type = "state", appendData = TRUE)
head(pred.exp)
pred.exp$type <- "change"

pred$type <- "orig"
pred.exp <- rbind(pred, pred.exp)

ggplot(data = pred.exp) +
  geom_line(aes(x = elev, y = Predicted, color = type))  + 
  geom_ribbon(aes(x = elev, ymin = lower, ymax = upper, fill = type), alpha = 0.1)+
  theme_minimal()
  
```
